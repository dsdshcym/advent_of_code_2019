defmodule AoC2019Test do
  use ExUnit.Case
  doctest AoC2019

  @input '''
  #################################################################################
  #.#...#.........#.#.....F.........#.....#.#.....#.........#...#.#.....K...#.....#
  #.#.#.#.#.#####.#.#.#########.###.#.#####.#.#.###.#####.###E#.#.#.#######.#.#.###
  #.#.#...#.#...#...#.#.....#j..#.#.#.....#.#.#.....#...#.....#p#.....#.....#.#...#
  #.#.#####.#.#.#####.###.###.###.#.#.###.#.#.#######.#########.#.#####.#.###.###.#
  #..r#...#.#.#.....#.....#...#.....#.#...#...#...........#.....#...#...#.#...#.#.#
  #.###.#.#.#.#####.#####.#.#####.#####.#.#.#######.#####.#.#######.#.#####.###.#.#
  #...O.#.#.D.#.......#.#.#.#..v#.......#.#.#.....#.....#.#.......#.#.....#.....#.#
  #######.#####.#####.#.#.#.#.#.#.#########.#.#.#.#######.#######.#####.#.###.###.#
  #.#...#.#.....#...#...#.#...#.#.#.....C.#.#.#.#.......#.......#.....#.#...#.#...#
  #.#.#.#.#N#.###.#.#####.#####.###.#####.#.###.#######.#######.#####.#.###.#.#.#.#
  #.#.#...#.#.#...#.......#...#.#.....#...#...#.....#...........#.....#.#.#...#.#o#
  #.#.#####.###.###########.#.#.#.#####.#####.###.#.###########.#.#####.#.#####.#.#
  #x#.....#.....#...........#.#...#.#..y#.#.#...#.#.#.....#.....#.#.....#.#.....#.#
  #.#####.#########.#########.#####.#.###.#.###.#.#.#.###.#######.#####.#.#.#####.#
  #...#...#.#.......#...#...#...#...#...#.#...#.#.#.....#...#.....#...#...#.#.....#
  #.#.#.###.#.#.#######.#.#.###.###.###.#.#.###.#.#########.#.#####.#.#####.#######
  #.#...#...#.#.#...Z.#...#.......#...#.#.#...#.#.#.....#...#...#...#.....#.......#
  #.#####.###.#.#.###.#.#########.#.###.#.###.#.###.###.#.#.###.###.#####.#######.#
  #.....#.#...#.#..z#m#.#.......#...#...#.#...#.....#...#.#.#.#...#...#.#.#.......#
  #####.#.#.###.###.#.###.#####.#####.###.#.#########.###.#.#.###.###.#.#.#.#####.#
  #...#.#.....#...#.#.#.#...#........u#...#.........#.#...#...#...#...#.#.#.#.....#
  #.#.#.#######.#.#.#.#.#.#.###########.#.#.#####.#.#.#.#####.#####.###.#.#.#.#####
  #.#.#.........#.#.#.#.#.#......g#.....#.#...#...#.#...#.....#.....#...#b#.#.#.H.#
  #.###########.###.#.#.#Q#######.#.#####.#####.#########.#####.#####.###.#.#.###.#
  #...........#.#...#.M.#...#.....#.....#.#.....#...#.....#.....#.......#.#.#...#.#
  #.###.#.#####.#T###########.#####.###.#.#.#.###.#.#.#####.#######.###.#.#.###.#.#
  #.#...#.#.....#.............#...#.#...#.#.#.#...#.#.......#.....#.#...#.#.#.....#
  ###.###.#.###################.#.###.#####.###.###.#########.###.#.#.###.#.#####.#
  #...#...#...#.................#.....#...#...#.#.#.....#.......#.#.#.#.W.#.#...#.#
  #.###.#####.#####.###################.#.#.#.#.#.#.###.#######.#.###.#.###.#.#.#.#
  #...#.....#.#...#...........#.....#.L.#.#.#...#.#...#.....#...#.#...#.#.....#.#.#
  #.#.#######.#.#.#########.#.#.###.#.###.#####.#.###.#####.#.###.#.#.#.#.#####.#.#
  #.#...#...#...#.........#.#.....#.....#.#...#.....#.....#.#.#.#.#.#.#.#.....#.#.#
  #A###.#.#.#############.###.#####.#####.#.#.###########.#.#.#.#.#.###.#######.###
  #...#.#.#.....#...#...#w..#.#...#.#.....#.#.............#.#.#....a#...#.....#...#
  ###.#S#.#.#####.#.#.#.###.###.#.###.###.#.#######.#######.#.#.#####.###.###.###.#
  #...#...#.B.....#.#.#...#...#.#...#.#.#.#.......#.#...#.....#...#...#.....#.#...#
  #.###############.#.#.#####.#.###.#.#.#.#.#####.###.#.###########.#######.#.#.#.#
  #...............#...#.........#.....#.........#.....#...........I.........#...#.#
  #######################################.@.#######################################
  #.........#.........#..i......#.....#.................#...#.........#...........#
  ###.#.#####.###.#####.#######.#.###.#.#.#.#########.#.#.#.#.###.#####.#########.#
  #...#.#h..#...#...#...#.....#.....#.#.#.#...#.....#.#...#...#...#.......#...#...#
  #.#####.#.###.###.#.###.#.#########.#.#.###.#.###.#.#########.###.#######.#.#.#.#
  #.#.....#...#...#.#...#.#.#.......#...#.#...#.#...#.........#...#s....#...#...#.#
  #.#.#######.#.###.###.#.#.#.#####.#####.#.#####.#.#########.#########.#.#########
  #...#.....#...#.....#.#.#.#...#.......#.#...#...#.#.....#...#.......#.#.........#
  #.#####.#######.#.###.#.#####.#######.#.###.#.###.###.###.###.#####.#.#########.#
  #.......#.......#.#...#.#.....#...#.#.#.#.#l#.#.#...#.#...#...#...#.#.#.......#.#
  #######.#.#####.###.###.#.#####.#.#.#.#.#.#.#.#.###.#.#.###.#####.#.#.#####.#.#.#
  #...#.#.#...#...#...#...#.#.....#.#.#...#.#...#...#.#.#.....#...#.#...#.....#.#.#
  #.#.#.#.###.#.###.###.###.#.#####.#.###.#.#####.#.#.#.#######.#.#.#####.###.###.#
  #.#...#...#.#...#.#...#...#.....#.#.....#.....#.#...#.........#.........#...#...#
  #.###.###.#.#####.#.###.#.#####.#.#.#####.###.#.#########.###################.#.#
  #...#...#.#.........#...#.....#.#.#.#...#.#...#.#.#.......#.................#.#.#
  #.#.#.###.###########.#######.#.#.#.#.#.#.#.###.#.#.#.#.###.###############.#.###
  #.#.#.#...#.....#.....#...#...#.#.#.#.#.#.#...#.#.#.#.#.#...#.........#.....#...#
  #.#.#.#.###.#####.#####.#.#####.#.###.#.#.#####.#.#.#.#.#.#######.#.#.#.#######.#
  #.#.#.#.#.....#...#.....#.....#.#.....#.#.......#...#.#.#.......#.#.#.#.#.....#.#
  #.#.###.#.###.#.###.#########.#.#######.#.###########.#.#######.###.#.#.#.###.#.#
  #.#.....#.#...#.#.G.#.#...#q..#.#.....#.#.#.#.........#.#.#...#...#.#.#...#.#.#.#
  #.#########.###.#.###.#.#.#.###U#.###.#.#.#.#.#.#######.#.#.#####.#.#.#####.#.#.#
  #.....#.....#...#t..#.#.#.#.....#...#.#.#.#...#.#.#...#.#.#.#.....#.#.......#.#.#
  #####.#.#####.#####.#.#.#.#########.#.#.#.#.###.#.#.#.#.#.#.#.#####.#.#######.#.#
  #.....#.#...#.....#...#.#...........#.#.#.#.#...#...#.#.#.#.#.#.....#.#...#...#.#
  #.#####.#.#.###.#.#####.#.#########.###.#.###.#######.#.#.#Y#.###.#####.#.#.###.#
  #.#.....#.#...#.#.......#.#.....#...#...#...#.#.....#.....#.#...#...#...#.#.....#
  #.#.#.###.###.###########.#.###.#.###.#####.#.#.###.#####.#.###.#.#.#.###.#####.#
  #.#.#.#...#.#.........#...#.#.#.#...#...#...#...#...#...#.#...#.#.#.....#...#...#
  #.#.###.###.#########.#.#.#.#.#.#######.#.###.###.###.#.#####.#.#########.###.###
  #...#...#.........#...#.#.#...#...#...#.#.#.....#.#...#.......#.........#.#...#.#
  ###.#.#######.#.###.###.#.###.###.#.#.#.#.#######.#.###########P#######.#.#.###.#
  #...#...R...#.#.........#.#.#.#.#...#...#.....#...#..c....#...#.#f..#...#.#...#.#
  #.#########.#.###########.#.#.#.#############.#.#.#######.#.#.#.#.###.###.###.#.#
  #.#...#...#.#.#...#...#...#.#.....#.....#...#...#.#...#.V.#.#.#...#...#.#d....#.#
  #.#.#.#.#.#.#.#.#.#.#.#.###.#####.#####.#.#######.#.###.###.#####.#.###.#.#####.#
  #.#.#...#.#.#.#.#.#.#.#.........#.#.....#.#...#...#...#...#.......#.#...#...#k..#
  #.#.#####.#.###.#.#.#.###########.#.###.#.#X#.#.#####.###.#########.#.#####.###.#
  #...#.....#.....#...#..n.........e..#...#...#...........#.......J...#...........#
  #################################################################################
  '''

  describe "part 1" do
    test "examples" do
      assert AoC2019.p1('''
             #########
             #b.A.@.a#
             #########
             ''') == 8

      assert AoC2019.p1('''
             ########################
             #f.D.E.e.C.b.A.@.a.B.c.#
             ######################.#
             #d.....................#
             ########################
             ''') == 86

      assert AoC2019.p1('''
             ########################
             #...............b.C.D.f#
             #.######################
             #.....@.a.B.c.d.A.e.F.g#
             ########################
             ''') == 132

      assert AoC2019.p1('''
             #################
             #i.G..c...e..H.p#
             ########.########
             #j.A..b...f..D.o#
             ########@########
             #k.E..a...g..B.n#
             ########.########
             #l.F..d...h..C.m#
             #################
             ''') == 136

      assert AoC2019.p1('''
             ########################
             #@..............ac.GI.b#
             ###d#e#f################
             ###A#B#C################
             ###g#h#i################
             ########################
             ''') == 81
    end

    @tag timeout: 90000
    test "test input" do
      assert AoC2019.p1(@input) == 4844
    end
  end

  describe "parse/3" do
    test "returns state when input is empty" do
      assert :state = AoC2019.parse('', {0, 0}, :state)
    end

    test "sets state.map[pos] to :open when current char is ?." do
      assert %{map: %{{0, 0} => :open}} = AoC2019.parse('.', {0, 0}, %{map: %{}})
    end

    test "sets state.map[pos] to :wall when current char is ?#" do
      assert %{map: %{{1, 0} => :wall}} = AoC2019.parse('#', {1, 0}, %{map: %{}})
    end

    test "sets state.map[pos] to key and updates state.keys when current char is a lower case letter" do
      assert %{map: %{{0, 1} => {:key, ?a}}, keys: keys} =
               AoC2019.parse('a', {0, 1}, %{map: %{}, keys: MapSet.new()})

      assert MapSet.member?(keys, ?a)
    end

    test "sets state.map[pos] to :door when current char is a upper case letter" do
      assert %{map: %{{1, 1} => {:door, ?B}}} = AoC2019.parse('B', {1, 1}, %{map: %{}})
    end

    test "sets state.map[pos] to open and state.entrance to pos when current char is @" do
      assert %{map: %{{3, 4} => :open}, entrance: {3, 4}} =
               AoC2019.parse('@', {3, 4}, %{map: %{}})
    end

    test "starts parsing for next line when current char is \n" do
      assert %{map: %{{0, 2} => :open}} = AoC2019.parse('\n.', {100, 1}, %{map: %{}})
    end
  end
end
